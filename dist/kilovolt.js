var k=Object.defineProperty,S=Object.defineProperties;var E=Object.getOwnPropertyDescriptors;var g=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var p=(n,e,s)=>e in n?k(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s,b=(n,e)=>{for(var s in e||(e={}))H.call(e,s)&&p(n,s,e[s]);if(g)for(var s of g(e))K.call(e,s)&&p(n,s,e[s]);return n},m=(n,e)=>S(n,E(e));var a=(n,e)=>k(n,"name",{value:e,configurable:!0});var u=class{constructor(){this._eventHandlers={}}isValidType(e){return typeof e=="string"}isValidHandler(e){return typeof e=="function"}on(e,s){if(!e||!s||!this.isValidType(e)||!this.isValidHandler(s))return!1;let t=this._eventHandlers[e];return t||(t=this._eventHandlers[e]=[]),t.indexOf(s)>=0?!1:(s._once=!1,t.push(s),!0)}once(e,s){if(!e||!s||!this.isValidType(e)||!this.isValidHandler(s))return!1;let t=this.on(e,s);return t&&(s._once=!0),t}off(e,s){if(!e)return this.offAll();if(!s){this._eventHandlers[e]=[];return}if(!this.isValidType(e)||!this.isValidHandler(s))return;let t=this._eventHandlers[e];if(!(!t||!t.length)){for(let r=0;r<t.length;r++)if(t[r]===s){t.splice(r,1);break}}}offAll(){this._eventHandlers={}}fire(e,s){if(!e||!this.isValidType(e))return;let t=this._eventHandlers[e];if(!t||!t.length)return;let r=this.createEvent(e,s);for(let i of t)!this.isValidHandler(i)||(i._once&&(r.once=!0),i(r),r.once&&this.off(e,i))}has(e,s){if(!e||!this.isValidType(e))return!1;let t=this._eventHandlers[e];return!t||!t.length?!1:!s||!this.isValidHandler(s)?!0:t.indexOf(s)>=0}getHandlers(e){return!e||!this.isValidType(e)?[]:this._eventHandlers[e]||[]}createEvent(e,s,t=!1){return{type:e,data:s,timestamp:Date.now(),once:t}}};a(u,"EventEmitter");var T=new u;function d(n){let e=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"],s=[];for(let t=0;t<n.length/4;t++){let c=[...n.slice(4*t,4*t+4)].map(o=>e.indexOf(o).toString(2).padStart(6,"0")).join("").match(/.{1,8}/g).map(o=>+("0b"+o));s.push(...c.slice(0,3-(n[4*t+2]=="="?1:0)-(n[4*t+3]=="="?1:0)))}return s}a(d,"base64ToBytesArr");function y(n){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=a(i=>i.toString(2).padStart(8,"0"),"bin"),t=n.length,r="";for(let i=0;i<=(t-1)/3;i++){let c=i*3+1>=t,o=i*3+2>=t;r+=(s(n[3*i])+s(c?0:n[3*i+1])+s(o?0:n[3*i+2])).match(/.{1,6}/g).map((w,v)=>v==3&&o||v==2&&c?"=":e[+("0b"+w)]).join("")}return r}a(y,"bytesArrToBase64");function R(){return Math.random().toString(32)}a(R,"generateRid");async function x(n,e,s){let r=new TextEncoder().encode(n),i=d(s),c=Uint8Array.from([...r,...i]),o=d(e),h=await window.crypto.subtle.importKey("raw",c,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]),f=await window.crypto.subtle.sign("HMAC",h,Uint8Array.from(o));return y(Array.from(new Uint8Array(f)))}a(x,"authChallenge");var l=class extends u{constructor(e="ws://localhost:4337/ws",s){super();this.address=e,this.password=s,this.pending={},this.keySubscriptions={},this.prefixSubscriptions={},this.connect(e)}reconnect(){this.connect(this.address)}connect(e){this.socket=new WebSocket(e),this.socket.addEventListener("open",this.open.bind(this)),this.socket.addEventListener("message",this.received.bind(this)),this.socket.addEventListener("close",this.closed.bind(this))}async wait(){return new Promise(e=>{if(this.socket.readyState===this.socket.OPEN){e();return}this.once("open",()=>e())})}async open(){if(console.info("connected to server"),this.password)try{await this.auth()}catch(e){this.fire("error",e),this.socket.close()}this.fire("open"),this.fire("stateChange",this.socket.readyState)}closed(){console.warn("lost connection to server"),this.fire("close"),this.fire("stateChange",this.socket.readyState)}received(e){e.data.split(`
`).map(t=>t.trim()).filter(t=>t.length>0).forEach(t=>{let r=JSON.parse(t!=null?t:'""');if("error"in r){this.fire("error",r);return}switch(r.type){case"response":r.request_id in this.pending?(this.pending[r.request_id](r),delete this.pending[r.request_id]):console.warn("Received a response for an unregistered request: ",r);break;case"push":{r.key in this.keySubscriptions&&this.keySubscriptions[r.key].forEach(i=>i(r.new_value,r.key)),Object.entries(this.prefixSubscriptions).filter(([i])=>r.key.startsWith(i)).forEach(([i,c])=>{c.forEach(o=>o(r.new_value,r.key))});break}default:}})}async auth(){var r;let e=await this.send({command:"klogin"});if("error"in e)throw new Error(e.error);let s=await x((r=this.password)!=null?r:"",e.data.challenge,e.data.salt),t=await this.send({command:"kauth",data:{hash:s}});if("error"in t)throw new Error(t.error)}async send(e){let s=m(b({},e),{request_id:"request_id"in e?e.request_id:R()});return new Promise(t=>{let r=JSON.stringify(s);this.socket.send(r),this.pending[s.request_id]=t})}async putKey(e,s){return this.send({command:"kset",data:{key:e,data:s}})}async putKeys(e){return this.send({command:"kset-bulk",data:e})}async putJSON(e,s){return this.send({command:"kset",data:{key:e,data:JSON.stringify(s)}})}async putJSONs(e){let s={};return Object.entries(e).forEach(([t,r])=>{s[t]=JSON.stringify(r)}),this.send({command:"kset-bulk",data:s})}async getKey(e){let s=await this.send({command:"kget",data:{key:e}});if("error"in s)throw new Error(s.error);return s.data}async getKeys(e){let s=await this.send({command:"kget-bulk",data:{keys:e}});if("error"in s)throw new Error(s.error);return s.data}async getKeysByPrefix(e){let s=await this.send({command:"kget-all",data:{prefix:e}});if("error"in s)throw new Error(s.error);return s.data}async getJSON(e){let s=await this.send({command:"kget",data:{key:e}});if("error"in s)throw new Error(s.error);return JSON.parse(s.data)}async getJSONs(e){let s=await this.send({command:"kget-bulk",data:{keys:e}});if("error"in s)throw new Error(s.error);let t={};return Object.entries(s.data).forEach(([r,i])=>{t[r]=JSON.parse(i)}),t}async subscribeKey(e,s){return e in this.keySubscriptions?this.keySubscriptions[e].push(s):this.keySubscriptions[e]=[s],this.send({command:"ksub",data:{key:e}})}async unsubscribeKey(e,s){if(!(e in this.keySubscriptions))return console.warn(`Trying to unsubscribe from key "${e}" but no subscriptions could be found!`),!1;let t=this.keySubscriptions[e].findIndex(r=>r===s);if(t<0)return console.warn(`Trying to unsubscribe from key "${e}" but specified function is not in the subscribers!`),!1;if(this.keySubscriptions[e].splice(t,1),this.keySubscriptions[e].length<1){let r=await this.send({command:"kunsub",data:{key:e}});return"error"in r&&console.warn(`unsubscribe failed: ${r.error}`),r.ok}return!0}async subscribePrefix(e,s){return e in this.keySubscriptions?this.prefixSubscriptions[e].push(s):this.prefixSubscriptions[e]=[s],this.send({command:"ksub-prefix",data:{prefix:e}})}async unsubscribePrefix(e,s){if(!(e in this.prefixSubscriptions))return console.warn(`Trying to unsubscribe from prefix "${e}" but no subscriptions could be found!`),!1;let t=this.prefixSubscriptions[e].findIndex(r=>r===s);if(t<0)return console.warn(`Trying to unsubscribe from key "${e}" but specified function is not in the subscribers!`),!1;if(this.prefixSubscriptions[e].splice(t,1),this.prefixSubscriptions[e].length<1){let r=await this.send({command:"kunsub-prefix",data:{prefix:e}});return"error"in r&&console.warn(`unsubscribe failed: ${r.error}`),r.ok}return!0}async keyList(e){let s=await this.send({command:"klist",data:{prefix:e!=null?e:""}});if("error"in s)throw new Error(s.error);return s.data}};a(l,"Kilovolt");var B=l;export{l as Kilovolt,B as default};
/**
 * A simple and lightweight EventEmitter by TypeScript for Node.js or Browsers.
 *
 * @author billjs
 * @see https://github.com/billjs/event-emitter
 * @license MIT(https://opensource.org/licenses/MIT)
 */
//# sourceMappingURL=kilovolt.js.map
